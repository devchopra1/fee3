// src/spotifyService.js

const API_BASE_URL = "https://api.spotify.com/v1";

/**
 * Maps a simple mood string to Spotify Audio Feature targets (0.0 to 1.0)
 */
const moodMap = {
    // High Valence (Happy) & High Energy (Excited) - Fast tempo music
    'excited': { target_valence: 0.85, target_energy: 0.9, target_danceability: 0.7, min_tempo: 120 },
    // Mid/High Valence & Low/Mid Energy (Uplifting but Relaxed) - Chill tempo
    'chill': { target_valence: 0.7, target_energy: 0.4, target_danceability: 0.5, max_tempo: 110 },
    // Low Valence (Sad) & Low Energy (Melancholy) - Slow tempo, acoustic
    'sad': { target_valence: 0.2, target_energy: 0.3, target_danceability: 0.4, max_tempo: 90 },
    // Mid Valence & High Energy (Aggressive, Workout) - Very fast tempo
    'pumped': { target_valence: 0.5, target_energy: 0.95, target_tempo: 140, min_danceability: 0.6 },
};

async function spotifyFetch(url, token, options = {}) {
    const defaultOptions = {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
        },
    };
    const finalOptions = {
        ...defaultOptions,
        ...options,
        // Merging headers ensures we don't lose Auth token if custom headers are passed
        headers: { ...defaultOptions.headers, ...options.headers } 
    };

    const response = await fetch(`${API_BASE_URL}${url}`, finalOptions);

    if (!response.ok) {
        // Log error details for debugging
        console.error(`Spotify API call failed: ${response.status} for ${url}`, await response.text());
        throw new Error(`Spotify API Error: ${response.statusText}`);
    }

    // Handle 204 No Content response (common for POST/PUT/DELETE requests)
    if (response.status === 204) return {}; 
    
    return response.json();
}

// --- CORE PLAYLIST FUNCTIONS ---

export async function getCurrentUserId(token) {
    const userProfile = await spotifyFetch('/me', token);
    return userProfile.id;
}

export async function getRecommendedTracks(token, mood) {
    const targets = moodMap[mood.toLowerCase()];

    if (!targets) {
        throw new Error(`Invalid mood: ${mood}`);
    }

    // Build the query parameters for the recommendation endpoint
    const queryParams = new URLSearchParams({
        limit: 25, // Get 25 songs
        // Use a mix of popular genres as starting seeds
        seed_genres: 'pop,rock,edm,chill', 
        ...targets, // Inject the mood-based audio features
    });

    const data = await spotifyFetch(`/recommendations?${queryParams.toString()}`, token);
    
    if (data.tracks.length === 0) {
        throw new Error("Spotify returned zero tracks for this mood. Try a different mood.");
    }

    return data.tracks.map(track => track.uri); // Return an array of track URIs
}

export async function createNewPlaylist(token, userId, mood) {
    const moodTitle = mood.charAt(0).toUpperCase() + mood.slice(1);
    const playlistName = `MoodPlayl.ist: ${moodTitle} Vibe`;
    
    const body = {
        name: playlistName,
        description: `A playlist generated by MoodPlayl.ist for a ${moodTitle} mood.`,
        public: true 
    };

    const playlist = await spotifyFetch(`/users/${userId}/playlists`, token, {
        method: 'POST',
        body: JSON.stringify(body),
    });

    // The playlist object contains the ID and the URL
    return { id: playlist.id, url: playlist.external_urls.spotify };
}

export async function addTracksToPlaylist(token, playlistId, trackUris) {
    const body = {
        uris: trackUris,
    };

    // This returns a 201 Created with a snapshot ID, but the content is often ignored
    await spotifyFetch(`/playlists/${playlistId}/tracks`, token, {
        method: 'POST',
        body: JSON.stringify(body),
    });
}

/**
 * Orchestrates the entire playlist creation process.
 */
export async function generatePlaylist(token, mood) {
    const userId = await getCurrentUserId(token);
    const trackUris = await getRecommendedTracks(token, mood);
    const { id: playlistId, url: playlistUrl } = await createNewPlaylist(token, userId, mood);
    
    await addTracksToPlaylist(token, playlistId, trackUris);
    
    return {
        name: `MoodPlayl.ist: ${mood.charAt(0).toUpperCase() + mood.slice(1)} Vibe`,
        url: playlistUrl,
        tracks: trackUris.length,
    };
}